name: release-plugin
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch, tag, SHA) to build. Defaults to the workflow ref."
        required: false
      base_version:
        description: "Base version (X.Y.Z) or tag name (vX.Y.Z) used if no release tag is present."
        required: false

jobs:
  build:
    name: Build IntelliJ plugin
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Resolve build ref
        id: build_ref
        shell: bash
        run: |
          REF_INPUT="${{ inputs.ref }}"
          TAG_NAME="${{ github.event.release.tag_name }}"
          if [ -n "$REF_INPUT" ]; then
            echo "ref=$REF_INPUT" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ref=${{ github.ref }}" >> "$GITHUB_OUTPUT"
          elif [ -n "$TAG_NAME" ]; then
            echo "ref=$TAG_NAME" >> "$GITHUB_OUTPUT"
          else
            echo "ref=${{ github.event.repository.default_branch }}" >> "$GITHUB_OUTPUT"
          fi
      - name: Checkout release source
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.build_ref.outputs.ref }}
          fetch-depth: 0
          path: release-src
      - name: Resolve version
        id: version
        shell: bash
        env:
          TAG_NAME: ${{ github.event.release.tag_name }}
          INPUT_VERSION: ${{ inputs.base_version }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_REF_TYPE: ${{ github.ref_type }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          bash release-src/verify.sh
      - name: Checkout default branch
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.repository.default_branch }}
          fetch-depth: 0
          path: repo
      - name: Bump plugin version (release source)
        shell: bash
        run: |
          python - <<'PY'
          from pathlib import Path
          import re
          import os

          version = os.environ["PLUGIN_VERSION"]
          path = Path(os.environ["TARGET_DIR"]) / "plugin/gradle.properties"
          text = path.read_text() if path.exists() else ""
          updated, count = re.subn(r'^(\\s*pluginVersion\\s*=\\s*)([^\\s#]+)', r'\\1' + version, text, flags=re.M)
          if count == 0:
              updated = f"pluginVersion={version}\\n{text}"
              count = 1
          if count != 1:
              raise SystemExit(f"Expected to update 1 version line, updated {count}")
          if updated != text or not path.exists():
              path.write_text(updated)
          PY
        env:
          PLUGIN_VERSION: ${{ steps.version.outputs.version }}
          TARGET_DIR: release-src
      - name: Bump plugin version (default branch)
        shell: bash
        run: |
          python - <<'PY'
          from pathlib import Path
          import re
          import os

          version = os.environ["PLUGIN_VERSION"]
          path = Path(os.environ["TARGET_DIR"]) / "plugin/gradle.properties"
          text = path.read_text() if path.exists() else ""
          updated, count = re.subn(r'^(\\s*pluginVersion\\s*=\\s*)([^\\s#]+)', r'\\1' + version, text, flags=re.M)
          if count == 0:
              updated = f"pluginVersion={version}\\n{text}"
              count = 1
          if count != 1:
              raise SystemExit(f"Expected to update 1 version line, updated {count}")
          if updated != text or not path.exists():
              path.write_text(updated)
          PY
        env:
          PLUGIN_VERSION: ${{ steps.version.outputs.version }}
          TARGET_DIR: repo
      - name: Commit version bump
        shell: bash
        run: |
          if git -C repo diff --quiet; then
            echo "No version change to commit."
            exit 0
          fi
          git -C repo config user.name "github-actions[bot]"
          git -C repo config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git -C repo add plugin/gradle.properties
          git -C repo commit -m "chore: bump plugin version to ${{ steps.version.outputs.version }}"
          git -C repo push origin HEAD:${{ github.event.repository.default_branch }}
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "17"
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
      - name: Build plugin
        working-directory: release-src/plugin
        env:
          MANIFEST_DEBUG: "1"
        run: |
          chmod +x ./gradlew
          ./gradlew buildPlugin
      - name: Upload release assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: release-src/plugin/build/distributions/*.zip
      - name: Upload workflow artifacts
        if: github.event_name != 'release'
        uses: actions/upload-artifact@v4
        with:
          name: intellij-plugin
          path: release-src/plugin/build/distributions/*.zip
