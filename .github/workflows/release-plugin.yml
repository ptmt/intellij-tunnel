name: release-plugin
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch, tag, SHA) to build. Defaults to the workflow ref."
        required: false
      base_version:
        description: "Base version (X.Y.Z) or tag name (vX.Y.Z) used if no release tag is present."
        required: false

jobs:
  build:
    name: Build IntelliJ plugin
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Resolve build ref
        id: build_ref
        shell: bash
        run: |
          REF_INPUT="${{ inputs.ref }}"
          TAG_NAME="${{ github.event.release.tag_name }}"
          if [ -n "$REF_INPUT" ]; then
            echo "ref=$REF_INPUT" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ref=${{ github.ref }}" >> "$GITHUB_OUTPUT"
          elif [ -n "$TAG_NAME" ]; then
            echo "ref=$TAG_NAME" >> "$GITHUB_OUTPUT"
          else
            echo "ref=${{ github.event.repository.default_branch }}" >> "$GITHUB_OUTPUT"
          fi
      - name: Checkout release source
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.build_ref.outputs.ref }}
          fetch-depth: 0
          path: release-src
      - name: Resolve version
        id: version
        shell: bash
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          INPUT_VERSION="${{ inputs.base_version }}"
          if [ -z "$TAG_NAME" ] && [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.ref_type }}" = "tag" ]; then
            TAG_NAME="${{ github.ref_name }}"
          fi
          if [ -n "$TAG_NAME" ]; then
            BASE_VERSION="$TAG_NAME"
          elif [ -n "$INPUT_VERSION" ]; then
            BASE_VERSION="$INPUT_VERSION"
          else
            BASE_VERSION="$(python - <<'PY'
          from pathlib import Path
          import re

          path = Path("release-src/plugin/gradle.properties")
          if not path.exists():
              raise SystemExit(f"Version is required (release tag, workflow input, or missing {path}).")
          text = path.read_text(encoding="utf-8")
          if text.startswith("\\ufeff"):
              text = text.lstrip("\\ufeff")
          match = re.search(r'^\\s*pluginVersion\\s*=\\s*([^\\s#]+)', text, flags=re.M)
          if not match:
              raise SystemExit(f"Version is required (release tag, workflow input, or {path}).")
          print(match.group(1))
          PY
            )"
          fi
          BASE_VERSION="${BASE_VERSION#v}"
          if [ -z "$BASE_VERSION" ]; then
            echo "Base version is required (release tag, workflow input, or gradle.properties)." >&2
            exit 1
          fi
          export BASE_VERSION
          VERSION="$(python - <<'PY'
          import os
          import re

          base = os.environ["BASE_VERSION"].strip()
          match = re.match(r'^(\\d+)\\.(\\d+)\\.(\\d+)(?:[.-].*)?$', base)
          if not match:
              raise SystemExit(f"Base version must look like X.Y.Z, got: {base}")
          major, minor, patch = (int(part) for part in match.groups())
          print(f"{major}.{minor}.{patch + 1}")
          PY
          )"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
      - name: Checkout default branch
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.repository.default_branch }}
          fetch-depth: 0
          path: repo
      - name: Bump plugin version (release source)
        shell: bash
        run: |
          python - <<'PY'
          from pathlib import Path
          import re
          import os

          version = os.environ["PLUGIN_VERSION"]
          path = Path(os.environ["TARGET_DIR"]) / "plugin/gradle.properties"
          text = path.read_text() if path.exists() else ""
          updated, count = re.subn(r'^(\\s*pluginVersion\\s*=\\s*)([^\\s#]+)', r'\\1' + version, text, flags=re.M)
          if count == 0:
              updated = f"pluginVersion={version}\\n{text}"
              count = 1
          if count != 1:
              raise SystemExit(f"Expected to update 1 version line, updated {count}")
          if updated != text or not path.exists():
              path.write_text(updated)
          PY
        env:
          PLUGIN_VERSION: ${{ steps.version.outputs.version }}
          TARGET_DIR: release-src
      - name: Bump plugin version (default branch)
        shell: bash
        run: |
          python - <<'PY'
          from pathlib import Path
          import re
          import os

          version = os.environ["PLUGIN_VERSION"]
          path = Path(os.environ["TARGET_DIR"]) / "plugin/gradle.properties"
          text = path.read_text() if path.exists() else ""
          updated, count = re.subn(r'^(\\s*pluginVersion\\s*=\\s*)([^\\s#]+)', r'\\1' + version, text, flags=re.M)
          if count == 0:
              updated = f"pluginVersion={version}\\n{text}"
              count = 1
          if count != 1:
              raise SystemExit(f"Expected to update 1 version line, updated {count}")
          if updated != text or not path.exists():
              path.write_text(updated)
          PY
        env:
          PLUGIN_VERSION: ${{ steps.version.outputs.version }}
          TARGET_DIR: repo
      - name: Commit version bump
        shell: bash
        run: |
          if git -C repo diff --quiet; then
            echo "No version change to commit."
            exit 0
          fi
          git -C repo config user.name "github-actions[bot]"
          git -C repo config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git -C repo add plugin/gradle.properties
          git -C repo commit -m "chore: bump plugin version to ${{ steps.version.outputs.version }}"
          git -C repo push origin HEAD:${{ github.event.repository.default_branch }}
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "17"
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
      - name: Build plugin
        working-directory: release-src/plugin
        run: |
          chmod +x ./gradlew
          ./gradlew buildPlugin
      - name: Upload release assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: release-src/plugin/build/distributions/*.zip
      - name: Upload workflow artifacts
        if: github.event_name != 'release'
        uses: actions/upload-artifact@v4
        with:
          name: intellij-plugin
          path: release-src/plugin/build/distributions/*.zip
